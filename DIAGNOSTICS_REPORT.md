# 项目诊断报告 (Project Diagnosis Report)

**版本 (Version):** 1.0
**评估日期 (Evaluation Date):** 2025-01-06

---

## 1. 总体评估 (Overall Assessment)

该项目是一个结构清晰、技术选型现代的全栈应用。其核心价值在于提供了一个复杂且智能的三阶段参考文献验证逻辑（Gemini -> CrossRef -> Google Search），这远超出一个简单的API调用封装。后端服务的置信度评分系统和流式处理（SSE）是显著亮点，展现了开发者在业务逻辑深度上的严肃思考。前端采用React和Zustand，响应式地处理实时数据，用户体验流畅。

项目已经超越了"最小可行产品"（MVP）的范畴，进入了一个需要**巩固、优化和明确未来方向**的阶段。当前的主要挑战并非功能缺失，而是如何将已有的复杂功能打磨得更健壮、可维护，并为下一阶段的扩展做好准备。

---

## 2. 存在的问题与风险 (Identified Issues & Risks)

尽管项目基础扎实，但若干问题若不加处理，可能成为未来发展的技术债务和风险点。

### 2.1. 关键风险：配置管理混乱 (Critical Risk: Configuration Management Chaos)

- **问题描述**: 代理服务器的配置在代码中多处硬编码 (`geminiServiceAxios.js`, `googleSearchService.js`, `proxy.js`)，且存在多个不同的IP地址（`127.0.0.1`, `172.27.224.1`）。这是最需要立即解决的问题。
- **风险**:
    - **环境脆弱性**: 强依赖于特定的本地开发环境（如WSL），在部署到生产环境或更换开发机时将立刻失效。
    - **维护噩梦**: 任何网络配置的变更都需要修改多处代码，极易出错和遗漏。
    - **安全性**: 将配置信息硬编码在代码中是反模式的，增加了敏感信息泄露的风险。

### 2.2. 高风险：文档与实现脱节 (High Risk: Discrepancy Between Documentation and Implementation)

- **问题描述**: `docs/ARCHITECTURE.md` 和 `PLANNING.md` 文件已过时，未能准确反映当前精妙的三阶段验证流程和更丰富的验证状态（如 `ambiguous`, `mismatch`）。
- **风险**:
    - **知识流失**: 项目的核心逻辑和设计思想未被记录，新成员难以快速理解项目，增加了维护成本。
    - **目标模糊**: 规划文档停滞，导致团队对下一步的目标和优先级没有清晰的共识。

### 2.3. 中风险：测试策略不完善 (Medium Risk: Incomplete Testing Strategy)

- **问题描述**: 项目包含了Jest依赖和大量的独立测试脚本 (`/tests/*.js`)，但并未形成一个统一、自动化的测试框架。这些脚本需要手动执行，无法有效地进行回归测试。
- **风险**:
    - **质量无法保证**: 在快速迭代中，无法系统性地确保新代码没有破坏现有功能。
    - **重构困难**: 缺乏可靠的自动化测试套件，使得对代码进行大规模重构（例如解决配置管理问题）的风险大大增加。

### 2.4. 中风险：代码冗余与职责不清 (Medium Risk: Code Redundancy)

- **问题描述**:
    - 后端存在两个功能高度重叠的验证控制器 (`verifyController.js` 和 `verifyControllerSSE.js`)。
    - `geminiService.js` 似乎已被 `geminiServiceAxios.js` 取代，但仍存在于代码库中。
- **风险**:
    - **维护成本增加**: 开发者需要理解并维护两套相似的逻辑。
    - **不一致性**: 未来的修改可能只在一处进行，导致两套API的行为不一致。

---

## 3. 改进规划与指令分配 (Improvement Plan & Agent Directives)

我将整个改进过程分为三个阶段，每个阶段都有明确的目标和交付成果。

### **第一阶段：清理技术债务，巩固现有成果 (Phase 1: Clear Technical Debt, Consolidate Gains)**

*这个阶段的目标是解决当前最紧迫的风险，使项目达到一个稳定、可维护、文档一致的基线。*

1.  **指令1.1 (最高优先级):** **重构配置管理**
    -   **任务**: 在 `.env` 文件中定义唯一的 `PROXY_URL` 环境变量。
    -   **要求**:
        -   移除所有在 `.js` 文件中硬编码的代理URL。
        -   所有需要代理的网络请求（axios, https-proxy-agent）都必须从该环境变量中读取配置。
        -   删除冗余的 `src/config/proxy.js` 文件，或将其改造为统一的代理配置中心。
        -   建议在 `.env.example` 中将代理默认设置为 `http://127.0.0.1:7890`，以方便新开发者。

2.  **指令1.2:** **更新项目文档**
    -   **任务**: 使 `docs/` 目录下的文档与当前实现保持一致。
    -   **要求**:
        -   重写 `ARCHITECTURE.md`，详细描述**三阶段验证架构**（Gemini解析 -> CrossRef验证 -> Google搜索验证），并绘制能反映此流程的架构图。
        -   明确列出所有可能的验证状态 (`verified`, `not_found`, `ambiguous`, `error` 等）及其含义。
        -   更新 `PLANNING.md`，将"MVP"阶段标记为已完成，并根据本报告制定新的"Phase 2: Enhancement"计划。

3.  **指令1.3:** **代码库清理**
    -   **任务**: 移除冗余和过时的代码。
    -   **要求**:
        -   废弃 `/api/verify-references` 路由和 `verifyController.js`。让前端所有请求都使用流式API。
        -   删除 `src/services/geminiService.js` 文件。

4.  **指令1.4:** **迁移并自动化测试**
    -   **任务**: 将 `/tests` 目录下的脚本迁移到Jest测试框架中。
    -   **要求**:
        -   为每个主要服务 (`geminiServiceAxios`, `googleSearchService`, `crossrefService`) 创建对应的 `*.test.js` 文件。
        -   利用Jest的 `mock` 功能模拟外部API调用，使测试不依赖于网络和API密钥。
        -   修改 `package.json` 中的 `test` 脚本，使其能运行所有Jest测试。

---

### **第二阶段：提升用户体验与功能深度 (Phase 2: Enhance UX & Feature Depth)**

*此阶段专注于从"能用"到"好用"，为用户提供更透明、更具价值的验证结果。*

1.  **指令2.1:** **丰富结果展示**
    -   **任务**: 改进前端 `ResultCard.jsx` 组件，提供更详细的验证反馈。
    -   **要求**:
        -   对于 `verified` 结果，清晰地展示匹配到的元数据（如DOI、标题、作者）。
        -   对于 `ambiguous` 或 `mismatch` 结果，高亮显示不匹配或低置信度的部分。
        -   对于 `google` 来源的结果，显示置信度分数。

2.  **指令2.2:** **优化错误处理**
    -   **任务**: 提供更具体、对用户更友好的错误信息。
    -   **要求**:
        -   后端在捕获到上游API（Gemini, Google）的特定错误时（如认证失败、配额用尽），应返回明确的错误码和信息。
        -   前端根据后端返回的错误信息，向用户展示可操作的提示（例如，"Gemini API密钥无效，请检查后端配置"）。

---

### **第三阶段：着眼未来与系统扩展 (Phase 3: Future-Proofing & Scalability)**

*此阶段为项目的长期发展和应对更大规模的使用场景做准备。*

1.  **指令3.1:** **引入缓存机制**
    -   **任务**: 为已验证的参考文献引入缓存（建议使用Redis）。
    -   **要求**:
        -   以原始参考文献字符串的哈希值作为缓存键（Cache Key）。
        -   在验证流程开始前检查缓存，若命中则直接返回结果，极大降低API调用成本和响应时间。

2.  **指令3.2:** **建立CI/CD流水线**
    -   **任务**: 利用GitHub Actions等工具实现自动化测试与部署。
    -   **要求**:
        -   配置工作流，在每次推送（push）或拉取请求（pull request）时自动运行第一阶段建立的Jest测试套件。
        -   （可选）配置自动部署流程，当代码合并到主分支且测试通过后，自动部署到目标服务器。

---
此报告将作为我们后续所有行动的指导蓝图。我将根据项目的进展和我们的讨论，持续更新此文件。 