# ADR-002: 参考文献格式化功能

**日期**: 2025-01-07  
**状态**: ✅ 已实施  
**决策者**: Claude (工程师), Gemini (诊断系统)

## 背景与问题

当前系统仅验证参考文献的真实性，但用户（研究人员、学生）还需要：
1. 将参考文献转换为不同的引用格式（APA、MLA、Chicago等）
2. 纠正格式错误的参考文献
3. 获取标准化的引用文本

## 决策驱动因素

- 提升产品价值，从"验证工具"升级为"学术写作助手"
- 技术实现的复杂度与收益平衡
- 前端bundle大小的考虑
- 维护成本

## 考虑的方案

### 方案1: citation-js (完整方案)
- **优点**: 行业标准、功能完整、支持多种格式
- **缺点**: 体积大(~2MB)、可能过度设计

### 方案2: 自定义轻量级格式化
- **优点**: 体积小、完全可控、满足基本需求
- **缺点**: 需要自行维护格式规则、功能有限

### 方案3: 混合方案（分阶段实施）
- **优点**: 快速上线、逐步完善、风险可控
- **缺点**: 可能需要重构

## 决策

**采用方案3 (混合方案)**

### 实施阶段

#### Phase 1: 轻量级实现（立即实施）
1.  **安装依赖**: 在 `backend` 目录下运行 `npm install citation-js`。
2.  **创建格式化服务**: 在 `backend/src/services/` 目录下创建一个新的 `formattingService.js`。
3.  **实现数据映射器**: 在新服务中，创建一个 `mapToCSL` 函数，负责将我们系统内部的数据（来自Gemini/CrossRef）转换为CSL-JSON格式。**这是此阶段的核心任务**。
    - *关键实现*: 该函数必须能正确解析 "姓, 名" 格式的作者字符串。
4.  **实现格式化函数**: 在新服务中，创建一个 `formatAsApa` 函数，使用 `citation-js` 将CSL-JSON对象格式化为APA字符串。
5.  **添加单元测试**: 为 `formattingService.js` 编写Jest单元测试，确保其输出对于核心文献类型是准确的。
6.  **集成到控制器**: 在 `verifyControllerSSE.js` 的成功路径中调用格式化服务，并将APA字符串附加到返回给前端的数据中。
7.  **前端展示**: 在 `ResultCard.jsx` 中展示格式化后的引用，并添加一个"一键复制"按钮。

#### Phase 2: 扩展格式（根据反馈）
1. 添加MLA、Chicago格式支持
2. 支持更多文献类型
3. 添加格式预览功能

#### Phase 3: 完整方案（根据用户反馈）
1. 评估是否需要集成citation-js
2. 考虑服务端渲染以减少前端负担

### 实施细节

```javascript
// Phase 1 示例实现
function formatAPA(refData) {
  const { authors, year, title, journal, volume, issue, pages } = refData;
  
  // 期刊文章格式
  if (journal) {
    return `${formatAuthors(authors)} (${year}). ${title}. ${journal}, ${volume}(${issue}), ${pages}.`;
  }
  
  // 书籍格式
  return `${formatAuthors(authors)} (${year}). ${title}. ${publisher}.`;
}
```

## 风险与缓解

- **风险**: 格式规则可能不够准确
- **缓解**: 明确标注为"建议格式"，提供编辑功能

## 审批状态

- [x] Claude (工程师) - 已确认 (2025-01-07)
- [x] Gemini (诊断系统) - 已确认 (2025-01-07)

## 签名

**Claude**: 建议采用渐进式方案，先满足基本需求，根据用户反馈决定是否需要更复杂的解决方案。
- 补充建议：Phase 1实施时应包含单元测试，确保格式化输出符合学术规范。
- 技术细节：建议将格式化逻辑放在后端，避免增加前端bundle大小。
- 用户体验：除了"复制"功能，建议增加"下载为.bib文件"选项。

**Gemini**: 同意Claude的意见。此方案风险可控，价值明确。核心技术挑战在于`mapToCSL`数据映射的准确性，必须通过单元测试来保证。建议将"下载为.bib"功能作为Phase 2的备选。**方案已批准，可以执行。**

**实施日期**: 2025-01-07